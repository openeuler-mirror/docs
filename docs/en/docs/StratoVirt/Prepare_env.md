# Preparing the Environment


## Usage

- StratoVirt supports only Linux VMs that use the x86_64 or AArch64 processor architecture and start the VM with same architecture.
- It is advised to compile, commission, and deploy the StratoVirt on openEuler 21.03.
- StratoVirt can run with non-root permissions.

## Environment Requirements

The following environment is required for running StratoVirt:

- /dev/vhost-vsock device (for implementing the MMIO)
- Nmap tool
- Kernel image and rootfs image



## Preparing Devices and Tools

- StratoVirt needs to implement the MMIO device. Therefore, before running StratoVirt, ensure that the `/dev/vhost-vsock` device exists.

  Check whether the device exists.

  ```
  $ ls /dev/vhost-vsock
  /dev/vhost-vsock
  ```

  If the device does not exist, run the following command to generate the /dev/vhost-vsock device:

  ```
  $ modprobe vhost_vsock
  ```


- To use QMP commands, install the nmap tool. After configuring the yum source, run the following command to install the nmap tool:

  ```
  # yum install nmap
  ```

## Preparing Images

### Creating the Kernel Image

The StratoVirt of the current version supports only the PE kernel image of the x86_64 and AArch64 platforms. The kernel image in PE format can be generated by using the following method:

1. Run the following command to obtain the kernel source code of the openEuler:

   ```
   $ git clone https://gitee.com/openeuler/kernel
   $ cd kernel
   ```

2. Run the following command to check and switch the kernel version to 4.19:

   ```
   $ git checkout kernel-4.19
   ```

3. Configure and compile the Linux kernel. It is better to use the recommended configuration file ([Obtain configuration file](https://gitee.com/openeuler/stratovirt/tree/master/docs/kernel_config)). Copy it to the kernel directory, and rename it as `.config`. You can also run the following command to configure the kernel as prompted:

   ```
   $ make menuconfig
   ```

4. Run the following command to create and convert the kernel image to the PE format. The converted image is vmlinux.bin.

   ```
   $ make -j vmlinux && objcopy -O binary vmlinux vmlinux.bin
   ```
   
5. If you want to use the kernel in bzImzge format on the x86 platform, run the following command:

   ```
   $ make -j bzImage
     â€‹

## Creating the Rootfs Image

The rootfs image is a file system image. When the StratoVirt is started, the ext4 image with init can be loaded. To create an ext4 rootfs image, perform the following steps:

1. Prepare a file with a proper size (for example, create a file with the size of 10 GiB in /home).

   ```
   $ cd /home
   $ dd if=/dev/zero of=./rootfs.ext4 bs=1G count=10
   ```

2. Create an empty ext4 file system on this file.

   ```
   $ mkfs.ext4 ./rootfs.ext4
   ```

3. Mount the file image. Create the /mnt/rootfs directory and mount rootfs.ext4 to the /mnt/rootfs directory as user root.

   ```
   $ mkdir /mnt/rootfs
   $ cd /home
   $ sudo mount ./rootfs.ext4 /mnt/rootfs && cd /mnt/rootfs
   ```
   
4. Obtain the latest alpine-mini rootfs of the corresponding processor architecture.

   - If the AArch64 processor architecture is used, run the following command:

     ```
     $ wget http://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/aarch64/alpine-minirootfs-3.12.0-aarch64.tar.gz
     $ tar -zxvf alpine-minirootfs-3.12.0-aarch64.tar.gz
     $ rm alpine-minirootfs-3.12.0-aarch64.tar.gz
     ```


   - For the x86_64 processor architecture, run the following command:

     ```
     $ wget http://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz
     $ tar -zxvf alpine-minirootfs-3.12.0-x86_64.tar.gz
     $ rm alpine-minirootfs-3.12.0-x86_64.tar.gz
     ```


5. Run the following command to create a simple /sbin/init for the ext4 file image:

   ```
   $ rm sbin/init; touch sbin/init && cat > sbin/init <<EOF
   #! /bin/sh
   mount -t devtmpfs dev /dev
   mount -t proc proc /proc
   mount -t sysfs sysfs /sys
   ip link set up dev lo
   
   exec /sbin/getty -n -l /bin/sh 115200 /dev/ttyS0
   poweroff -f
   EOF
   
   sudo chmod +x sbin/init
   ```

6. Uninstall the rootfs image.

   ```
   $ cd /home; umount /mnt/rootfs
   ```

   Then, the rootfs is created successfully. You can use the ext4 rootfs image file rootfs.ext4, which is stored in the /home directory.

## Getting firmware for standard boot

Firmware refers to the device driver stored inside the device. The operating system can only be started according to the standard boot mode through firmware. Stratovirt only supports booting from UEFI (Unified Extensible Firmware Interface) on x86_64 and AArch64 platform.

EDK II is an open-source project that implements UEFI specification. StratoVirt use EDK II as the firmware to boot VM, and therefore we have to get the corresponding EDK II binary. We can install EDK II directly by yum. Notes that EDK II binary contains two files, one for executable code storage and the other for boot data storage.

On x86_64 platform, run

```shell
$ sudo yum install -y edk2-ovmf
```

On aarch64 platform, run

```shell
$ sudo yum install -y edk2-aarch64
```

After installing edk2, on x86_64 platform, `OVMF_CODE.fd` and `OVMF_VARS.fd` are located in `/usr/share/edk2/ovmf` directory. On aarch64 platform, `QEMU_EFI-pflash.raw` and `vars-template-pflash.raw` are located in `/usr/share/edk2/aarch64` directory.
